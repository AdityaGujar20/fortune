<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UAN No. Highlighter</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-2xl">
        <h1 class="text-2xl font-bold mb-6 text-center">UAN No. Highlighter</h1>
        
        <!-- Upload Form -->
        <div id="upload-section">
            <form id="upload-form" enctype="multipart/form-data" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Excel File (.xlsx)</label>
                    <input type="file" name="excel" accept=".xlsx" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">PDF File (.pdf)</label>
                    <input type="file" name="pdf" accept=".pdf" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Upload Files</button>
            </form>
        </div>
        
        <!-- Column Selection -->
        <div id="column-selection" class="hidden space-y-4 mt-6">
            <div>
                <label class="block text-sm font-medium text-gray-700">UAN Column</label>
                <select id="uan-column" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                    <option value="">Select UAN Column</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Site Column</label>
                <select id="site-column" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                    <option value="">Select Site Column</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Highlight Mode</label>
                <select id="highlight-mode" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                    <option value="border">Border</option>
                    <option value="highlight">Highlight</option>
                    <option value="underline">Underline</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Highlight Color</label>
                <select id="color" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                    <option value="red">Red</option>
                    <option value="blue">Blue</option>
                    <option value="green">Green</option>
                    <option value="black">Black</option>
                    <option value="orange">Orange</option>
                    <option value="yellow">Yellow</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Opacity (0-1)</label>
                <input type="number" id="opacity" min="0" max="1" step="0.01" value="0.25" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
            </div>
            <button id="process-btn" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">Process Files</button>
        </div>
        
        <!-- Progress Bar -->
        <div id="progress-section" class="hidden mt-6">
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <p id="progress-text" class="text-center mt-2">Processing: 0%</p>
        </div>
        
        <!-- Results -->
        <div id="results-section" class="hidden mt-6">
            <h2 class="text-lg font-semibold">Results</h2>
            <ul id="file-list" class="mt-2 space-y-2"></ul>
            <div class="mt-4 flex space-x-4">
                <button id="download-zip" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Download All (ZIP)</button>
                <button id="refresh-btn" class="flex-1 bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700">Refresh</button>
            </div>
        </div>
        
        <!-- Error Message -->
        <div id="error-section" class="hidden mt-6">
            <p id="error-message" class="text-red-600"></p>
            <button id="error-refresh" class="mt-4 w-full bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700">Refresh</button>
        </div>
    </div>

    <script>
        let jobId = null;

        // Upload form submission
        document.getElementById('upload-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            
            jobId = result.job_id;
            
            if (result.status === 'columns') {
                document.getElementById('upload-section').classList.add('hidden');
                document.getElementById('column-selection').classList.remove('hidden');
                
                const uanSelect = document.getElementById('uan-column');
                const siteSelect = document.getElementById('site-column');
                
                result.columns.forEach(col => {
                    const option1 = document.createElement('option');
                    option1.value = col;
                    option1.textContent = col;
                    uanSelect.appendChild(option1);
                    
                    const option2 = document.createElement('option');
                    option2.value = col;
                    option2.textContent = col;
                    siteSelect.appendChild(option2);
                });
            } else {
                showError(result.message);
            }
        });

        // Process button
        document.getElementById('process-btn').addEventListener('click', async () => {
            const uanColumn = document.getElementById('uan-column').value;
            const siteColumn = document.getElementById('site-column').value;
            const highlightMode = document.getElementById('highlight-mode').value;
            const color = document.getElementById('color').value;
            const opacity = document.getElementById('opacity').value;
            
            if (!uanColumn || !siteColumn) {
                showError('Please select both UAN and Site columns');
                return;
            }
            
            document.getElementById('column-selection').classList.add('hidden');
            document.getElementById('progress-section').classList.remove('hidden');
            
            const response = await fetch('/process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    job_id: jobId,
                    uan_column: uanColumn,
                    site_column: siteColumn,
                    highlight_mode: highlightMode,
                    color: color,
                    opacity: opacity
                })
            });
            const result = await response.json();
            
            if (result.status === 'processing') {
                checkProgress();
            } else {
                showError(result.message);
            }
        });

        // Check progress
        async function checkProgress() {
            const response = await fetch(`/progress/${jobId}`);
            const result = await response.json();
            
            document.getElementById('progress-bar').style.width = `${result.progress}%`;
            document.getElementById('progress-text').textContent = `Processing: ${result.progress}%`;
            
            if (result.status === 'completed') {
                showResults();
            } else if (result.status === 'error') {
                showError('Processing failed');
            } else {
                setTimeout(checkProgress, 1000);
            }
        }

        // Show results
        async function showResults() {
            document.getElementById('progress-section').classList.add('hidden');
            document.getElementById('results-section').classList.remove('hidden');
            
            const response = await fetch(`/results/${jobId}`);
            const result = await response.json();
            
            if (result.status === 'completed') {
                const fileList = document.getElementById('file-list');
                result.files.forEach(file => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="/download/${jobId}/${file}" class="text-blue-600 hover:underline">${file}</a>`;
                    fileList.appendChild(li);
                });
                
                document.getElementById('download-zip').addEventListener('click', () => {
                    window.location.href = `/download_zip/${jobId}`;
                });
                
                document.getElementById('refresh-btn').addEventListener('click', async () => {
                    await fetch(`/cleanup/${jobId}`);
                    window.location.reload();
                });
            } else {
                showError(result.message);
            }
        }

        // Show error
        function showError(message) {
            document.getElementById('progress-section').classList.add('hidden');
            document.getElementById('column-selection').classList.add('hidden');
            document.getElementById('error-section').classList.remove('hidden');
            document.getElementById('error-message').textContent = message;
            
            document.getElementById('error-refresh').addEventListener('click', async () => {
                if (jobId) {
                    await fetch(`/cleanup/${jobId}`);
                }
                window.location.reload();
            });
        }
    </script>
</body>
</html>